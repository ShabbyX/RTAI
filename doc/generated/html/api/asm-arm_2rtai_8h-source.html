<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RTAI API: base/include/asm-arm/rtai.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<div class="nav">
<a class="el" href="dir_000000.html">base</a>&nbsp;/&nbsp;<a class="el" href="dir_000015.html">include</a>&nbsp;/&nbsp;<a class="el" href="dir_000016.html">asm-arm</a></div>
<h1>rtai.h</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/* 020222 asm-arm/rtai.h</span>
00002 <span class="comment">Copyright (C) 2003, Thomas Gleixner, &lt;tglx@linutronix.de)</span>
00003 <span class="comment">COPYRIGHT (C) 2002 Guennadi Liakhovetski, DSA GmbH <gl@dsa-ac.de></span>
00004 <span class="comment">COPYRIGHT (C) 2002 Wolfgang Müller <wolfgang.mueller@dsa-ac.de></span>
00005 <span class="comment">Copyright (C) 2001 Alex Züpke, SYSGO RTS GmbH <azu@sysgo.de></span>
00006 <span class="comment"></span>
00007 <span class="comment">This program is free software; you can redistribute it and/or modify</span>
00008 <span class="comment">it under the terms of version 2 of the GNU General Public License as</span>
00009 <span class="comment">published by the Free Software Foundation.</span>
00010 <span class="comment"></span>
00011 <span class="comment">This program is distributed in the hope that it will be useful,</span>
00012 <span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00013 <span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00014 <span class="comment">GNU General Public License for more details.</span>
00015 <span class="comment"></span>
00016 <span class="comment">You should have received a copy of the GNU General Public License</span>
00017 <span class="comment">along with this program; if not, write to the Free Software</span>
00018 <span class="comment">Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00019 <span class="comment">*/</span>
00020 <span class="comment">/*</span>
00021 <span class="comment">--------------------------------------------------------------------------</span>
00022 <span class="comment">Acknowledgements</span>
00023 <span class="comment">- Paolo Mantegazza      (mantegazza@aero.polimi.it)</span>
00024 <span class="comment">        creator of RTAI </span>
00025 <span class="comment">*/</span>
00026
00027 <span class="preprocessor">#ifndef _RTAI_ASM_ARM_RTAI_H</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#define _RTAI_ASM_ARM_RTAI_H</span>
00029 <span class="preprocessor"></span>
00030 <span class="preprocessor">#define rt_printk_srq           1</span>
00031 <span class="preprocessor"></span>
00032 <span class="preprocessor">#define NR_GLOBAL_IRQS          NR_IRQS</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#define NR_CPU_OWN_IRQS         NR_GLOBAL_IRQS</span>
00034 <span class="preprocessor"></span>
00035 <span class="preprocessor">#define RTAI_1_IPI  -1 </span><span class="comment">/* Just to make things compile */</span>
00036 <span class="preprocessor">#define RTAI_2_IPI  -1</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_3_IPI  -1</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_4_IPI  -1</span>
00039 <span class="preprocessor"></span>
00040 <span class="comment">// Do not be messed up by macros names below, is a trick for keeping i386 code.</span>
00041 <span class="preprocessor">#define FREQ_8254       FREQ_SYS_CLK</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#define LATENCY_8254    LATENCY_MATCH_REG</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#define SETUP_TIME_8254 SETUP_TIME_MATCH_REG</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#define FREQ_APIC       FREQ_SYS_CLK</span>
00045 <span class="preprocessor"></span>
00046 <span class="preprocessor">#define RT_TIME_END 0x7FFFFFFFFFFFFFFFLL</span>
00047 <span class="preprocessor"></span>
00048 <span class="preprocessor">#define DECLR_8254_TSC_EMULATION</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#define TICK_8254_TSC_EMULATION</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#define SETUP_8254_TSC_EMULATION</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#define CLEAR_8254_TSC_EMULATION</span>
00052 <span class="preprocessor"></span>
00053 <span class="keyword">struct </span>desc_struct { <span class="keywordtype">void</span> *fun; };
00054
00055 <span class="comment">/* not all ARM cores support 32bit x 32bit = 64bit native ... */</span>
00056 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> ullmul(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> m0, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> m1)
00057 {
00058         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> res;
00059
00060         res = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> long)m0 * (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> long)m1;
00061
00062         <span class="keywordflow">return</span> res;
00063 }
00064
00065 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> ulldiv(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> ull, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> uld, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *r)
00066 {
00067         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> q = ull/(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> long) uld;
00068
00069         *r = (<span class="keywordtype">unsigned</span> long) (ull - q * (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> long) uld);
00070
00071         <span class="keywordflow">return</span> q;
00072 }
00073
00074 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> imuldiv(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> i, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> mult, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> div)
00075 {
00076         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> q , r;
00077         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> m;
00078
00079         <span class="keywordflow">if</span> ( mult == div )
00080                 <span class="keywordflow">return</span> i;
00081
00082         m = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> long) i * (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> long) mult);
00083         q = (<span class="keywordtype">unsigned</span> long) (m / (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> long) div);
00084         r = (<span class="keywordtype">unsigned</span> long) (m - (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> long) q * (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> long) div );
00085
00086         <span class="keywordflow">return</span> (r + r) &lt; div ? q : q + 1;
00087 }
00088
00089 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> llimd(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> ull, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> mult, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> div)
00090 {
00091         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> low, high, q;
00092         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> r;
00093
00094         low  = ullmul(((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;ull)[0], mult);
00095         high = ullmul(((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;ull)[1], mult);
00096         q = ulldiv(high,div,&amp;r) &lt;&lt; 32;
00097         high = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> long) r) &lt;&lt; 32;
00098         q += ulldiv( high + low, div , &amp;r);
00099         <span class="keywordflow">return</span> (r + r) &lt; div ? q : q + 1;
00100 }
00101
00102 <span class="preprocessor">#ifdef __KERNEL__</span>
00103 <span class="preprocessor"></span>
00104 <span class="preprocessor">#ifndef __cplusplus</span>
00105 <span class="preprocessor"></span><span class="preprocessor">#include &lt;asm/rtai_debug.h&gt;</span> <span class="comment">/* Keep it first */</span>
00106 <span class="preprocessor">#include &lt;rtai_types.h&gt;</span>
00107 <span class="preprocessor">#include &lt;asm/rtai_fpu.h&gt;</span>
00108 <span class="preprocessor">#include &lt;asm/rtai_atomic.h&gt;</span>
00109 <span class="preprocessor">#include &lt;linux/ptrace.h&gt;</span>
00110 <span class="preprocessor">#include &lt;linux/spinlock.h&gt;</span>
00111 <span class="preprocessor">#include &lt;asm/io.h&gt;</span>
00112 <span class="preprocessor">#include &lt;asm/ptrace.h&gt;</span>
00113 <span class="preprocessor">#include &lt;asm/irq.h&gt;</span>
00114 <span class="preprocessor">#include &lt;asm/system.h&gt;</span>
00115 <span class="preprocessor">#include &lt;asm/bitops.h&gt;</span>
00116 <span class="preprocessor">#include &lt;asm/proc/hard_system.h&gt;</span>
00117 <span class="preprocessor">#endif </span><span class="comment">/* __cplusplus */</span>
00118
00119 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keyword">volatile</span> <span class="keywordtype">int</span> *locked_cpus;
00120
00121 <span class="preprocessor">#ifndef CONFIG_SMP</span>
00122 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> cpu_present_map;
00123 <span class="preprocessor">#define smp_num_cpus 1</span>
00124 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00125 <span class="preprocessor"></span>
00126 <span class="preprocessor">#ifndef CONFIG_RTAI_FPU_SUPPORT</span>
00127 <span class="preprocessor"></span><span class="preprocessor">#define enable_fpu()</span>
00128 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00129 <span class="preprocessor"></span>
00130 <span class="preprocessor">#define hard_unlock_all(flags) hard_restore_flags((flags))</span>
00131 <span class="preprocessor"></span><span class="preprocessor">#define hard_save_flags_and_cli(x) hard_save_flags_cli((x))</span>
00132 <span class="preprocessor"></span><span class="preprocessor">#define IRQ_DESC irq_desc</span>
00133 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keyword">struct </span>rt_times rt_times;
00134
00135 <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rtai_irq_mask_t;
00136
00137 <span class="keyword">extern</span> <span class="keywordtype">void</span> send_ipi_shorthand(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> shorthand, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> irq);
00138 <span class="keyword">extern</span> <span class="keywordtype">void</span> send_ipi_logical(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> dest, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> irq);
00139 <span class="preprocessor">#define rt_assign_irq_to_cpu(irq, cpu)</span>
00140 <span class="preprocessor"></span><span class="preprocessor">#define rt_reset_irq_to_sym_mode(irq)</span>
00141 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">int</span>  rt_request_global_irq_ext(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> irq, <span class="keywordtype">void</span> (*handler)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span> *, <span class="keyword">struct</span> pt_regs *), <span class="keywordtype">void</span> *dev_id);
00142 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> rt_request_global_irq(<span class="keywordtype">int</span> irq, <span class="keywordtype">void</span> (*handler)(<span class="keywordtype">void</span>))
00143 {
00144         <span class="keywordflow">return</span> rt_request_global_irq_ext(irq, (<span class="keywordtype">void</span> (*)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span>*, <span class="keyword">struct</span> pt_regs*))handler, NULL);
00145 }
00146 <span class="keyword">extern</span> <span class="keywordtype">int</span>  rt_free_global_irq(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> irq);
00147 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga80">rt_ack_irq</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> irq);
00148 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga78">rt_mask_and_ack_irq</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> irq);
00149 <span class="keyword">extern</span> <span class="keywordtype">void</span> rt_unmask_irq(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> irq);
00150 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rt_startup_irq(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> irq);
00151 <span class="keyword">extern</span> <span class="keywordtype">void</span> rt_shutdown_irq(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> irq);
00152 <span class="keyword">extern</span> <span class="keywordtype">void</span> rt_enable_irq(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> irq);
00153 <span class="keyword">extern</span> <span class="keywordtype">void</span> rt_disable_irq(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> irq);
00154 <span class="keyword">extern</span> <span class="keywordtype">int</span> rt_request_linux_irq(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> irq,
00155         <span class="keywordtype">void</span> (*linux_handler)(<span class="keywordtype">int</span> irq, <span class="keywordtype">void</span> *dev_id, <span class="keyword">struct</span> pt_regs *regs),
00156         <span class="keywordtype">char</span> *linux_handler_id, <span class="keywordtype">void</span> *dev_id);
00157 <span class="keyword">extern</span> <span class="keywordtype">int</span> rt_free_linux_irq(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> irq, <span class="keywordtype">void</span> *dev_id);
00158 <span class="keyword">extern</span> <span class="keywordtype">void</span> rt_tick_linux_timer(<span class="keywordtype">void</span>);
00159 <span class="keyword">extern</span> <span class="keyword">struct </span>desc_struct rt_set_full_intr_vect(unsigned int vector, int type, int dpl, void *handler);
00160 <span class="keyword">extern</span> <span class="keywordtype">void</span> rt_reset_full_intr_vect(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vector, <span class="keyword">struct</span> desc_struct idt_element);
00161 <span class="preprocessor">#define rt_set_intr_handler(vector, handler) ((void *)0)</span>
00162 <span class="preprocessor"></span><span class="preprocessor">#define rt_reset_intr_handler(vector, handler)</span>
00163 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">int</span> rt_request_srq(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> label, <span class="keywordtype">void</span> (*rtai_handler)(<span class="keywordtype">void</span>), <span class="keywordtype">long</span> <span class="keywordtype">long</span> (*user_handler)(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> whatever));
00164 <span class="keyword">extern</span> <span class="keywordtype">int</span> rt_free_srq(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> srq);
00165 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga84">rt_pend_linux_irq</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> irq);
00166 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga87">rt_pend_linux_srq</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> srq);
00167 <span class="preprocessor">#define rt_request_cpu_own_irq(irq, handler) rt_request_global_irq((irq), (handler))</span>
00168 <span class="preprocessor"></span><span class="preprocessor">#define rt_free_cpu_own_irq(irq) rt_free_global_irq((irq))</span>
00169 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">void</span> rt_request_timer(<span class="keywordtype">void</span> (*handler)(<span class="keywordtype">void</span>), <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tick, <span class="keywordtype">int</span> apic);
00170 <span class="keyword">extern</span> <span class="keywordtype">void</span> rt_request_timer_cpuid(<span class="keywordtype">void</span> (*handler)(<span class="keywordtype">void</span>), <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tick, <span class="keywordtype">int</span> cpuid);
00171 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga94">rt_free_timer</a>(<span class="keywordtype">void</span>);
00172 <span class="keyword">struct </span>apic_timer_setup_data { <span class="keywordtype">int</span> mode, count; };
00173 <span class="comment">//extern void rt_request_apic_timers(void (*handler)(void), struct apic_timer_setup_data *apic_timer_data);</span>
00174 <span class="comment">//extern void rt_free_apic_timers(void);</span>
00175 <span class="keyword">extern</span> <span class="keywordtype">void</span> rt_mount_rtai(<span class="keywordtype">void</span>);
00176 <span class="keyword">extern</span> <span class="keywordtype">void</span> rt_umount_rtai(<span class="keywordtype">void</span>);
00177 <span class="keyword">extern</span> <span class="keywordtype">int</span> rt_printk(<span class="keyword">const</span> <span class="keywordtype">char</span> *format, ...);
00178 <span class="keyword">extern</span> <span class="keywordtype">int</span> rtai_print_to_screen(<span class="keyword">const</span> <span class="keywordtype">char</span> *format, ...);
00179 <span class="keyword">extern</span> <span class="keywordtype">int</span> rt_is_linux(<span class="keywordtype">void</span>);
00180
00181 <span class="keyword">extern</span> RT_TRAP_HANDLER rt_set_rtai_trap_handler(<span class="keywordtype">int</span> trap, RT_TRAP_HANDLER handler);
00182 <span class="keyword">extern</span> <span class="keywordtype">void</span> rt_free_rtai_trap_handler(<span class="keywordtype">int</span> trap);
00183
00184 <span class="preprocessor">#define ffnz(ul) (ffs(ul)-1)</span>
00185 <span class="preprocessor"></span>
00186 <span class="comment">/* Timers are architecture dependent */</span>
00187 <span class="preprocessor">#include &lt;asm-arm/arch/rtai_arch.h&gt;</span>
00188 <span class="preprocessor">#include &lt;asm-arm/arch/rtai_timer.h&gt;</span>
00189
00190 <span class="keyword">extern</span> <span class="keywordtype">void</span> asmlinkage up_task_sw(<span class="keywordtype">void</span> *, <span class="keywordtype">void</span> *, <span class="keywordtype">void</span> *);
00191 <span class="keyword">extern</span> <span class="keywordtype">void</span> rt_switch_to_linux(<span class="keywordtype">int</span> cpuid);
00192 <span class="keyword">extern</span> <span class="keywordtype">void</span> rt_switch_to_real_time(<span class="keywordtype">int</span> cpuid);
00193
00194 <span class="preprocessor">#define rt_spin_lock(whatever)</span>
00195 <span class="preprocessor"></span><span class="preprocessor">#define rt_spin_unlock(whatever)</span>
00196 <span class="preprocessor"></span>
00197 <span class="preprocessor">#define rt_get_global_lock()  hard_cli()</span>
00198 <span class="preprocessor"></span><span class="preprocessor">#define rt_release_global_lock()</span>
00199 <span class="preprocessor"></span>
00200 <span class="preprocessor">#define hard_cpu_id()  0</span>
00201 <span class="preprocessor"></span>
00202 <span class="preprocessor">#define NR_RT_CPUS  1</span>
00203 <span class="preprocessor"></span>
00204 <span class="preprocessor">#define RTAI_NR_TRAPS 32</span>
00205 <span class="preprocessor"></span>
00206 <span class="preprocessor">#define save_cr0_and_clts(x)</span>
00207 <span class="preprocessor"></span>
00208 <span class="preprocessor">#define restore_cr0(x)</span>
00209 <span class="preprocessor"></span>
00210 <span class="comment">/* Macro to retrieve the link register */</span>
00211 <span class="preprocessor">#define getlr(x)                \</span>
00212 <span class="preprocessor">        ({                      \</span>
00213 <span class="preprocessor">        __asm__ __volatile__(   \</span>
00214 <span class="preprocessor">        "mov    %0, lr"         \</span>
00215 <span class="preprocessor">          : "=r" (x)            \</span>
00216 <span class="preprocessor">          :                     \</span>
00217 <span class="preprocessor">          : "memory");          \</span>
00218 <span class="preprocessor">        })</span>
00219 <span class="preprocessor"></span>
00220 <span class="preprocessor">#ifdef CONFIG_RTAI_FPU_SUPPORT</span>
00221 <span class="preprocessor"></span><span class="comment">/* someone should implement FPU support if necessary ... */</span>
00222 <span class="keyword">extern</span> <span class="keywordtype">void</span> save_fpenv(<span class="keywordtype">long</span> *fpu_reg);
00223 <span class="keyword">extern</span> <span class="keywordtype">void</span> restore_fpenv(<span class="keywordtype">long</span> *fpu_reg);
00224 <span class="keyword">typedef</span> <span class="keyword">struct </span>arm_fpu_env { <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> fpu_reg[1]; } FPU_ENV;
00225 <span class="preprocessor">#else</span>
00226 <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span>arm_fpu_env { <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> fpu_reg[1]; } FPU_ENV;
00227 <span class="preprocessor">#endif</span>
00228 <span class="preprocessor"></span>
00229 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> hard_lock_all(<span class="keywordtype">void</span>)
00230 {
00231         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags;
00232         hard_save_flags_and_cli(flags);
00233         hard_clf(); <span class="comment">/* we should block FIQs too */</span>
00234         <span class="keywordflow">return</span> flags;
00235 }
00236
00237 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_spin_lock_irq(<span class="keyword">volatile</span> spinlock_t *lock)
00238 {
00239         hard_cli();
00240         rt_spin_lock(lock);
00241 }
00242
00243 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_spin_unlock_irq(<span class="keyword">volatile</span> spinlock_t *lock)
00244 {
00245         rt_spin_unlock(lock);
00246         hard_sti();
00247 }
00248
00249 <span class="comment">// Note that the spinlock calling convention below for irqsave/restore is </span>
00250 <span class="comment">// sligtly different from the one used in Linux. Done on purpose to get an </span>
00251 <span class="comment">// error if you use Linux spinlocks in real time applications as they do not</span>
00252 <span class="comment">// guaranty any protection because of the soft irq disable. Be careful and</span>
00253 <span class="comment">// sure to call the other spinlocks the right way, as they are compatible</span>
00254 <span class="comment">// with Linux.</span>
00255
00256 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rt_spin_lock_irqsave(<span class="keyword">volatile</span> spinlock_t *lock)
00257 {
00258         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags;
00259         hard_save_flags_and_cli(flags);
00260         rt_spin_lock(lock);
00261         <span class="keywordflow">return</span> flags;
00262 }
00263
00264 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_spin_unlock_irqrestore(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags, <span class="keyword">volatile</span> spinlock_t *lock)
00265 {
00266         rt_spin_unlock(lock);
00267         hard_restore_flags(flags);
00268 }
00269
00270 <span class="comment">/* Global interrupts and flags control (simplified, and modified, version of */</span>
00271 <span class="comment">/* similar global stuff in Linux irq.c).                                     */</span>
00272
00273 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_global_cli(<span class="keywordtype">void</span>)
00274 {
00275         rt_get_global_lock();
00276 }
00277
00278 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_global_sti(<span class="keywordtype">void</span>)
00279 {
00280         rt_release_global_lock();
00281         hard_sti();
00282 }
00283
00284 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> rt_global_save_flags_and_cli(<span class="keywordtype">void</span>)
00285 {
00286         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags;
00287
00288         hard_save_flags_and_cli(flags);
00289         <span class="keywordflow">if</span> (!test_and_set_bit(hard_cpu_id(), locked_cpus)) {
00290                 <span class="keywordflow">while</span> (test_and_set_bit(31, locked_cpus));
00291                 <span class="keywordflow">return</span> ((~flags &amp; I_BIT) | 1);
00292         } <span class="keywordflow">else</span> {
00293                 <span class="keywordflow">return</span> (~flags &amp; I_BIT);
00294         }
00295 }
00296
00297 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_global_save_flags(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *flags)
00298 {
00299         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> hflags, rflags;
00300
00301         hard_save_flags_and_cli(hflags);
00302         hflags = ~hflags &amp; I_BIT;
00303         rflags = hflags | !test_bit(hard_cpu_id(), &amp;locked_cpus);
00304         <span class="keywordflow">if</span> (hflags) {
00305                 hard_sti();
00306         }
00307         *flags = rflags;
00308 }
00309
00310 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_global_restore_flags(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags)
00311 {
00312         <span class="keywordflow">switch</span> (flags) {
00313                 <span class="keywordflow">case</span> I_BIT | 1:
00314                         rt_release_global_lock();
00315                         hard_sti();
00316                         <span class="keywordflow">break</span>;
00317                 <span class="keywordflow">case</span> I_BIT | 0:
00318                         rt_get_global_lock();
00319                         hard_sti();
00320                         <span class="keywordflow">break</span>;
00321                 <span class="keywordflow">case</span> 0 | 1:
00322                         rt_release_global_lock();
00323                         <span class="keywordflow">break</span>;
00324                 <span class="keywordflow">case</span> 0 | 0:
00325                         rt_get_global_lock();
00326                         <span class="keywordflow">break</span>;
00327         }
00328 }
00329
00330 <span class="keyword">struct </span>calibration_data {
00331         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cpu_freq;
00332         <span class="keywordtype">int</span> latency;
00333         <span class="keywordtype">int</span> setup_time_TIMER_CPUNIT;
00334         <span class="keywordtype">int</span> setup_time_TIMER_UNIT;
00335         <span class="keywordtype">int</span> timers_tol[NR_RT_CPUS];
00336 };
00337
00338 <span class="keyword">extern</span> <span class="keyword">struct </span>rt_times rt_smp_times[NR_RT_CPUS];
00339 <span class="keyword">extern</span> <span class="keyword">struct </span>calibration_data tuned;
00340
00341 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> xchg_u32(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *up, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> val)
00342 {
00343         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags, ret;
00344
00345         hard_save_flags_and_cli(flags);
00346         ret = *up;
00347         *up = val;
00348         hard_restore_flags(flags);
00349         <span class="keywordflow">return</span> ret;
00350 }
00351
00352 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> linux_save_flags_and_cli_cpuid(<span class="keywordtype">int</span>);
00353
00354 <span class="preprocessor">#endif </span><span class="comment">/* !__KERNEL__ */</span>
00355
00356 <span class="preprocessor">#endif </span><span class="comment">/* !_RTAI_ASM_ARM_RTAI_H */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jan 18 22:53:52 2005 for RTAI API by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
